---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tags = new Set<string>();

  posts
    .filter((post: CollectionEntry<'blog'>) => !post.data.draft)
    .forEach((post: CollectionEntry<'blog'>) => {
      post.data.tags.forEach((tag: string) => tags.add(tag.toLowerCase().replace(/\s+/g, '-')));
    });

  return Array.from(tags).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props as { tag: string };
const normalizeTag = (value: string) => value.toLowerCase().replace(/\s+/g, '-');
const base = import.meta.env.BASE_URL;
const basePath = base.endsWith('/') ? base : `${base}/`;

const posts = (await getCollection('blog'))
  .filter((post: CollectionEntry<'blog'>) => !post.data.draft)
  .filter((post: CollectionEntry<'blog'>) =>
    post.data.tags.map((item: string) => normalizeTag(item)).includes(tag)
  )
  .sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const displayTag = tag.replace(/-/g, ' ');
---

<BaseLayout title={`${displayTag} â€” spandan`} description={`Posts tagged ${displayTag}.`}>
  <div class="container">
    <section class="hero">
      <h1>#{displayTag}</h1>
      <p class="hero-description">
        {posts.length} post{posts.length !== 1 ? 's' : ''} tagged with {displayTag}.
      </p>
    </section>

    <section class="section">
      <div class="post-list">
        {posts.map((post: CollectionEntry<'blog'>) => (
          <a class="post-item" href={`${basePath}posts/${post.slug}/`}>
            <time class="post-date">{post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</time>
            <h3 class="post-title">{post.data.title}</h3>
            <p class="post-excerpt">{post.data.description}</p>
            <div class="post-tags">
              {post.data.tags.slice(0, 3).map((item: string) => (
                <span class="tag">{item}</span>
              ))}
            </div>
          </a>
        ))}
      </div>
    </section>
  </div>
</BaseLayout>
